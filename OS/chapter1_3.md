## 1.3 操作系统运行环境

### 1.3.1 处理器运行模式

计算机系统中，CPU执行两种不同性质的程序：一种是**操作系统内核程序**；另一种是**用户自编程序**。内核程序要执行一些特权指令，而用户自编程序不能执行这些指令。

-   特权指令：是指不允许用户直接使用的指令，如I/O指令、置中断指令，存取用于内存保存的寄存器、送程序状态字到程序状态字寄存器等的指令。
-   非特权指令：是指允许用户直接使用的指令，它不能直接访问系统中的软硬件资源，仅限于访问用户的地址空间，这是为了防止用户程序对系统造成破坏。

CPU的运行模式划分为用户态和核心态。应用程序运行在用户态，操作系统内核程序运行在核心态。应用程序想操作系统请求服务时通过使用访管指令，从而产生一个中断事件将操作系统转换为核心态。

操作系统的各项功能分别被设置在了不同的层次上，与硬件关联紧密的模块，如时钟管理、中断处理、设备驱动等处于最底层。其次是运行频率较高的程序，如进程管理、存储器管理和设备管理等。这两部分构成了操作系统的内核，指令操作工作在核心态。

内核的四大功能：

1.   **时钟管理**

     时钟的第一功能是计时，操作系统需要通过时钟管理，向用户提供标准的系统时间。通过时钟中断的管理，可以实现进程的切换。

2.   **中断机制**

     中断技术的初衷是提高多道程序运行环境中CPU的利用率，主要针对与外部设备。中断机制中，只有一小部分功能属于内核，它们负责保护和恢复中断现场的信息，转移控制到相关的处理程序。

3.   **原语**

     按层次结构设计的操作系统，底层是一些可被调用的公用小程序，它们各自完成一个规定操作。特点如下：

     -   处于操作系统的最底层，是最接近硬件的部分
     -   这些程序的运行具有原子性，其操作只能一气呵成
     -   这些程序的运行时间都较短，而且调用频繁

4.   **系统控制的数据结构及处理**

     系统中用来登记状态信息的数据结构很多，如作业控制块、进程控制块(PCB)、设备控制块、各类链表、消息队列、缓冲区、空闲区登记表、内存分配表等。

     -   进程管理。进程状态管理、进程调度和分派、创建与撤销进程控制块等
     -   存储器管理。存储器的空间分配和回收、内存信息保护程序、代码对换程序等
     -   设备管理。缓冲区管理、设备分配和回收等。



### 1.3.2 中断和异常的概念

操作系统需要一些机制来进行核心态和用户态的转换，便引入了中断机制。

1.   **中断和异常的定义**

     中断(Interruption)也称为外中断，是指来自CPU执行指令外部的事件，通常用于信息输入/输出，如设备发出的I/O结束中断，表示设备输入/输出处理已经完成。时钟中断，表示一个固定的时间片已到，让处理机处理计时、启动定时运行的任务等。

     异常(Exception)也称内中断，是指来自CPU执行指令内部的事件，如程序的非法操作码、地址越界、运算溢出、虚存系统的缺页及专门的陷入指令等引起的事件。

2.   **中断和异常的分类**

     外中断可分为可屏蔽中断和不可屏蔽中断。可屏蔽中断是指通过INTR线发出的中断请求，通过改变屏蔽字可以实现多重中断，从而使得中断处理更加灵活。不可屏蔽中断是指通过NMI线发出的中断请求，通常是紧急的硬件故障，如电源掉电等。此外，异常也是不能被屏蔽的。

     异常可分为故障、自陷和终止。

     -   故障(Fault)通常是由指令执行引起的异常，如非法操作码、缺页故障、除数为0、运算溢出等。
     -   自陷(Trap)是一种事先安排的“异常”事件，用于在用户态下调用操作系统内核程序，如条件陷入指令。
     -   终止(Abort)是指出现了使得CPU无法继续执行的硬件故障，如控制器出错、存储器校验错等。

     故障异常和自陷异常属于软件中断，终止异常和外部中断属于硬件中断。

3.   **中断和异常的处理过程**

     中断和异常处理过程的大致描述：当CPU在执行用户程序的第i条指令时检测到一个异常事件，或在执行第i条指令后发现一个中断请求信号，则CPU打断当前的用户程序，然后转到相应的中断或异常处理程序去执行。若中断或异常处理程序能够解决相应的问题，则在中断或异常处理程序的最后，CPU通过执行中断或异常返回指令，回到被打断的用户程序的第i条指令或第i+1条指令继续执行；若中断或异常处理程序发现是不可恢复的致命错误，则终止用户程序。



### 1.3.3 系统调用

系统调用是指用户在程序中调用操作系统所提供的一些子功能，系统调用可视为特殊的公共子程序。

功能分类：

-   设备管理。完成设备的请求或释放，以及设备启动等功能
-   文件管理。完成文件的读、写、创建及删除等功能
-   进程控制。完成进程的创建、撤销、阻塞及唤醒等功能
-   进程通信。完成进程之间的消息传递或信号传递等功能
-   内存管理。完成内存的分配、回收以及获取作业占用内存区大小及始址等功能

用户态转向核心态：用户程序要求操作系统的服务，即系统调用；发生一次中断；用户程序中产生一个错误状态；从核心态转向用户态由一条指令实现，这条指令也是特权命令，一般是中断返回指令。



### 1.3.4 习题

#### 选择题

1.   下列关于操作系统的说法中，错误的是( )

     Ⅰ.  在通用操作系统管理下的计算机上运行程序，需要向操作系统预订运行时间		
     
     Ⅱ. 在通用操作系统管理下的计算机上运行程序，需要确定起始地址，并从这个地址开始执行
     
     Ⅲ.操作系统需要提供给高级程序设计语言的编译器
     
     Ⅳ.管理计算机系统资源是操作系统关心的主要问题
     
     A.I、III				B.II、III				C.I、II、III、IV 		D.以上答案都正确

A, I: 通用操作系统使用时间片轮转调度算法，用户运行程序并不需要预先预订运行时间；III: 编译器是操作系统的上层软件， 不是操作系统需要提供的功能



2.   下列说法中，正确的是( )

     Ⅰ. 批处理的主要缺点是需要大量内存	

     Ⅱ. 当计算机提供了核心态和用户态时，输入/输出指令必须在核心态下执行

     Ⅲ.操作系统中采用多道程序设计技术的最主要原因是提高CPU和外部设备的可靠性

     Ⅳ.操作系统中，通道技术是一种硬件技术

     A.I、II				B.I、III				C.II、IV 		D.II、III、IV

C, I: 批处理的主要缺点是缺少交互性;III:多道程序设计是为了提高系统利用率和吞吐量而提出的 



4.   ( )是操作系统必须提供的功能

     A. 图形用户界面(GUI)		B.为进程提供系统调用命令		C. 中断处理			D. 编译原理

     

C,中断是操作系统必须提供的功能，因为计算机的各种错误都需要中断处理，核心态与用户态切换也需要中断处理



5.   用户程序在用户态下要使用特权指令引起的中断属于( )

A.硬件故障中断				B. 程序中断				C. 外部中断						D.访管中断

D, 因操作系统不允许用户直接执行某些“危险性高”的指令，因此用户态运行这些指令的结果会转成操作系统的核心态去运行。这个过程就是访管中断。



9.   计算机区分核心态和用户态指令后，从核心态到用户态的转换是由操作系统程序执行后完成的，而用户态到核心态的转换则是由( )完成的

     A. 硬件                           B.  核心态程序              C.用户程序                       D. 中断处理程序

A, 计算机通过硬件中断机制完成由用户态到核心态。





11.   "访管"指令( )使用

      A. 仅在用户态下                 B. 仅在核心态下             C. 在规定时间内                 D.在调度时间内

A



12.   当CPU执行操作系统代码时，处理器处于( )

A. 自由态							B.用户态 					C. 核心态							D. 就绪态

C



13.   在操作系统中，只能在核心态下执行的指令是( )

      A. 读时钟							B. 取数						C. 广义指令						D.寄存器清0

C, 广义指令即系统调用命令，工作在核心态



14.   下列选项中，必须在核心态执行的指令是( )

      A. 从内存中取数																B.将运算结果装入内存 

      C.算术运算																		D.输入/输出

D，输入/输出涉及到中断操作，而中断处理是由系统内核负责的，工作在核心态。



16.   ( )程序可执行特权指令

      A. 同组用户				B.操作系统			C.特权用户					D.一般用户

B，特权指令只能由操作系统程序执行



19.   中断处理和子程序调用都需要压栈以保护现场，中断处理一定会保存而子程序调用不需要保存其内容的是( )

      A. 程序计数器											B. 程序状态寄存器

      C. 通用数据寄存器									 D. 通用地址寄存器

B，子程序调用只需保存程序断点，即该指令的下一条指令的地；中断处理不仅要保存断点(PC的内容)，还要保存程序状态字寄存器(PSW)的内容。在中断处理中，最重要的两个寄存器是PC和PSWR



20.   下列选项中，会导致用户进程从用户态切换到内核态的操作是( )

​		I. 整数除以零         II. sin()函数调用          III.read系统调用

​		A.仅I、II             B.仅I、III              C.仅II、III               D.I、II和III

B，需要在系统内核态执行的操作是整数除以零操作(需要中断处理)和read系统调用函数，sin()函数调用在用户态下进行的



22.   处理外部中断时，应该由操作系统保存的是( )

      A. 程序计数器(PC)的内容                          		B.通用寄存器的内容

      C.块表(TLB)中的内容										D.Cache中的内容

B，外部中断处理过程，PC值由中断隐指令自动保存，而通用寄存器内容由操作系统保存



23.   假定下列指令已装入指令寄存器，则执行时不可能导致CPU从用户态变为内核态的是( )

      A.DIV R0,R1 				;(R0)/(R1) --> R0

      B.INT n						 ;产生软中断

      C.NOT R0					 ;寄存器R0的内容取非

      D.MOV R0, adds           ;把地址addr处的内存数据放入寄存器R0

C，考虑到部分指令可能出现异常，从而转到核心态。指令A有除零异常的可能，指令B为中断指令，指令D由缺页异常的可能，指令C不会发生异常。



24.   异常是指令执行过程中在处理器内部发生的特殊事件，中断是来自处理器外部的请求时间。下列关于中断或异常情况的叙述中，错误的是( )

      A.“访存时缺页”属于中断							B.“整数除以0”属于异常

      C.“DMA传送结束”属于中断						D.“存储保护错”属于异常

A，中断是指来自CPU执行命令以外事件的发生，如设备发出的I/O结束中断，表示设备输入/输出处理已经完成。希望处理机能够向设备发出下一个输入/输出请求，同时让完成输入/输出后的程序继续运行。时钟中断，表示一个固定的时间片已到，让处理机处理计时、启动定时运行的任务等。





25.   执行系统调用的过程包括如下主要操作：

      a.返回用户态									b.执行陷入(trap)指令

      c.传递系统调用参数						 d.执行相应的服务程序

      A. b-->c-->a-->d								B. b-->d--->c-->a

      C. c-->b-->d-->a								D. c-->d-->b-->a

C，执行系统调用的过程如下：正在运行的进程先传递系统调用参数，然后由陷入(trap)指令负责将用户态转换为内核态，并将返回地址压入堆栈以备后用，接下来CPU执行相应的内核态服务程序，最后返回用户态。



28.   下列与中断相关的操作中，由操作系统完成的是( )

      I. 保存被中断程序的中断点

      II.提供中断服务

      III.初始化中断向量表

      IV.保存中断屏蔽字

      A.仅I、II				B.仅I、II、IV			C.仅III、IV				D.仅II、III、IV

D，当CPU检测到中断信号后，由硬件自动保存被中断程序的断点，I错误。之后，硬件找到该中断向量信号对应的中断向量，中断向量指明中断服务程序入口地址。接下来执行中断服务程序，保存PSW、保存中断屏蔽字、保存各通用寄存器的值，并提供与中断信号对应的中断服务



29.   下列指令中，只能在内核态执行的是( )

      A. trap指令			B.I/O指令			C.数据传送指令			D.设置断电指令

B，在内核态下，CPU可执行任何指令，在用户态下CPU只能执行非特权指令，而特权指令只能在内核态下执行。常见的特权指令有：1.有关对I/O设备操作的指令；2.有关访问程序状态的指令；3.存取特殊寄存器的指令；4.其他指令





#### 综合

1.   处理器为什么区分核心态和用户态两种操作方式？在什么情况下进行两种方式的切换？

区分执行态的目的是为了保护系统程序。用户态到核心态的转换发生在中断产生时，而核心态到用户态的转换则发生在中断返回用户程序时。

2.   为什么说直到出现中断和通道技术后，多道程序概念才变得有用？

多道程序并发执行是指有的程序正在CPU上执行，而另一些程序正在I/O设备上进行传输，即通过CPU操作与外设传输在时间上的重叠必须有中断和通道技术的支持，原因如下：

-   通道是一种控制一台或多台外部设备的硬件机构，它一旦被启动就独立于CPU运行，因而做到了输入/输出操作与CPU并行工作。
-   在硬件上引入中断技术。所谓中断，就是在输入/输出结束时，或硬件发生某种故障时，由相应的硬件向CPU发出信号，这时CPU立即停下工作而转向处理中断请求，待处理完中断后再继续原来的工作。

因此，通道技术和中断技术结合起来就可以实现CPU与I/O设备并行工作，即CPU启动通道传输数据后便去执行其他程序的计算工作，而通道则进行输入/输出操作；当通道工作结束时，再通过中断机构向CPU发出中断请求，CPU则暂停正在执行的操作，对出现的中断进行处理，处理完再继续原来的工作。

